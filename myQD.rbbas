#tag ClassProtected Class myQDInherits Shell	#tag Event		Sub Completed()		  Dim tos As TextOutputStream		  Dim content As String		  		  content=me.ReadAll().Trim().ReplaceB("<head>", "<head><meta charset=""utf-8"" />")		  // Fix default encoding issue.		  		  // Date		  // <a class='answer_permalink' action_mousedown='AnswerPermalinkClickthrough' href='[^']+' id='[^']+'>((Updat|Answer)ed (\w\w\w \d\d?)(, 20\d\d)?)</a>		  		  // Images		  // <img class=".+?zoomable_in zoomable_in_feed" src=".+?main-qimg-.+?" master_src="[^"]+"		  		  		  Dim r As New RegEx		  Dim rm As RegExMatch		  		  r.Options.CaseSensitive=False		  r.Options.DotMatchAll=True		  r.Options.TreatTargetAsOneLine=True		  r.SearchPattern="<a class='answer_permalink' action_mousedown='AnswerPermalinkClickthrough' href='[^']+' id='[^']+'>((Updat|Answer)ed (\w\w\w \d\d?)(, 20\d\d)?)</a>"		  rm=r.Search(content)		  		  Dim myDate As String		  		  If rm<>Nil Then		    myDate=rm.SubExpressionString(1)+", "+rm.SubExpressionString(2)+rm.SubExpressionString(3)		    If rm.SubExpressionString(3)="" Then		      // No year, so it's this year		      myDate=myDate+", "+ThisYear		    End If		    Window1.log(myDate)		    // Dunno what to do with it yet. Anyway.		  End If		  		  // Images		  r.SearchPattern="<img class="".+?zoomable_in zoomable_in_feed"" src="".+?main-qimg-(\w+)-\w+"" master_src=""([^""]+)"""		  rm=r.Search(content)		  While rm<>Nil		    Dim sh As New Shell		    sh.Execute "cd """+imgFolder.ShellPath+""" ; curl -s "+rm.SubExpressionString(2)+" > "+rm.SubExpressionString(1)+" ; hexdump -C -n 12 "+rm.SubExpressionString(1)		    Dim ext As String		    ext=sh.Result.Trim()		    If ext.InStrB("ff d8 ff ")>0 Then		      sh.Execute "cd """+imgFolder.ShellPath+""" ; mv "+rm.SubExpressionString(1)+" "+rm.SubExpressionString(1)+".jpg"		    ElseIf ext.InStrB("89 50 4e 47 0d 0a 1a")>0 Then		      sh.Execute "cd """+imgFolder.ShellPath+""" ; mv "+rm.SubExpressionString(1)+" "+rm.SubExpressionString(1)+".png"		    End If		    rm=r.Search(content, rm.SubExpressionStartB(0)+rm.SubExpressionString(0).Len)		  Wend		  		  		  tos=tos.Create(FileLink)		  tos.Write(content)		  tos.Flush()		  tos.Close()		  tos=Nil		  		  Window1.log("Worker "+Str(MyNumber)+" successfully downloaded "+Str(CurrentIndex)+" ["+Str(content.LenB)+" bytes]")		  Window1.LogSuccess(CurrentIndex)		  NextAnswer()		  		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub AddLink(url As String, ix As Integer)		  Links.Append url		  Indexes.Append ix		End Sub	#tag EndMethod	#tag Method, Flags = &h1		Protected Sub NextAnswer()		  If Links.Ubound=-1 Then		    StillWorking=0		    Return		  End If		  		  Dim s, t(-1) As String		  s=Links.Pop()		  CurrentIndex=Indexes.pop()		  t=s.SplitB("/")		  FileLink=rootFolder.Child("Answer_"+Str(CurrentIndex)+".html")		  Window1.log("Worker "+Str(MyNumber)+" getting "+Str(CurrentIndex)+": "+s)		  		  me.Execute "curl -s "+s		  		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub Run(ix As Integer, rf As FolderItem, img As FolderItem)		  me.Mode=1		  rootFolder=rf		  imgFolder=img		  MyNumber=ix		  StillWorking=1		  		  Dim d As New Date		  ThisYear=Str(d.Year)		  		  NextAnswer()		  		End Sub	#tag EndMethod	#tag Property, Flags = &h1		Protected CurrentIndex As Integer = -1	#tag EndProperty	#tag Property, Flags = &h1		Protected FIleLink As FolderItem	#tag EndProperty	#tag Property, Flags = &h0		imgFolder As FolderItem	#tag EndProperty	#tag Property, Flags = &h1		Protected Indexes() As Integer	#tag EndProperty	#tag Property, Flags = &h1		Protected Links() As String	#tag EndProperty	#tag Property, Flags = &h1		Protected MyNumber As Integer = -1	#tag EndProperty	#tag Property, Flags = &h1		Protected rootFolder As FolderItem	#tag EndProperty	#tag Property, Flags = &h0		StillWorking As Integer = 0	#tag EndProperty	#tag Property, Flags = &h1		Protected ThisYear As String	#tag EndProperty	#tag ViewBehavior		#tag ViewProperty			Name="Arguments"			Visible=true			EditorType="String"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="Backend"			Visible=true			EditorType="String"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="Index"			Visible=true			Group="ID"			Type="Integer"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="Left"			Visible=true			Group="Position"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="Mode"			Visible=true			EditorType="Integer"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="Name"			Visible=true			Group="ID"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="StillWorking"			Group="Behavior"			InitialValue="0"			Type="Integer"		#tag EndViewProperty		#tag ViewProperty			Name="Super"			Visible=true			Group="ID"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="TimeOut"			Visible=true			EditorType="Integer"			InheritedFrom="Shell"		#tag EndViewProperty		#tag ViewProperty			Name="Top"			Visible=true			Group="Position"			InheritedFrom="Shell"		#tag EndViewProperty	#tag EndViewBehaviorEnd Class#tag EndClass